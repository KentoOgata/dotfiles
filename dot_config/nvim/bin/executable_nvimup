#!/usr/bin/env -S deno run --allow-env --allow-run --ext ts

const directory = `${Deno.env.get("HOME")}/repos/github.com/neovim/neovim`;

function install(logWriter: Deno.Writer): void {
  const gitClone = new Deno.Command("git", {
    args: [
      "clone",
      "https://github.com/neovim/neovim.git",
      directory,
    ],
  });
  logWriter.write(gitClone.outputSync().stdout);

  const make = new Deno.Command("make", {
    args: [
      `CMAKE_INSTALL_PREFIX=${Deno.env.get("XDG_DATA_HOME")}/nvim`,
      "CMAKE_BUILD_TYPE=RelWithDebInfo",
    ],
    cwd: directory,
  });
  logWriter.write(make.outputSync().stdout);

  const install = new Deno.Command("make", {
    args: [
      "install",
    ],
    cwd: directory,
  });
  logWriter.write(install.outputSync().stdout);
}

function upgrade(logWriter: Deno.Writer): void {
  const gitPull = new Deno.Command("git", {
    args: [
      "pull",
      "-p",
    ],
    cwd: directory,
  });
  logWriter.write(gitPull.outputSync().stdout);

  const make = new Deno.Command("make", {
    cwd: directory,
  });
  logWriter.write(make.outputSync().stdout);

  const install = new Deno.Command("make", {
    args: [
      "install",
    ],
    cwd: directory,
  });
  logWriter.write(install.outputSync().stdout);
}

function showHelp(): void {
  console.log(
    "\ninstall - Install Neovim to ${XDG_DATA_HOME}/nvim/bin\nupgrade - Upgrade your Neovim.\n",
  );
}

const method = Deno.args[0];
if (method == "install") {
  install(Deno.stdout);
} else if (method == "upgrade") {
  upgrade(Deno.stdout);
} else if (method == "help") {
  showHelp();
} else {
  showHelp();
  Deno.exit(1);
}
Deno.exit(0);
